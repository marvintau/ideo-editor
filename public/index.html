<html>
    <style>
body{
    background: #8abeb7;
    text-align: center;
}

                #canvas{
                    margin: 10px;
                    border: true;
                    background: white;
                }
                textarea{
                    font-family : "TheSansMono Office";
                margin: 10px;
                resize: none;
                    border : none;
                width: 600px;
                background: white;
                }


    </style>
    <body>
        <div id="canvas_wrap">
            <canvas id="canvas" width="600" height="600" ></canvas>
        </div>
        <div>
            <div>
                <textarea id="stroke-list" rows="10" spellcheck="false">[{"name":"木"}, {"name":"木", "conds":{"concat":{"place":"right"}}},
                    {"name":"女", "conds":{"concat":{"place":"bottom"}}}]</textarea>
            </div>
    </body>
    <script src="./javascripts/structure.js"></script>
    <script>

        function loadJSON (json_filename) {

            return new Promise(function (resolve, reject) {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', json_filename, true);

                xhr.onload = function () {
                    if (this.status >= 200 && this.status < 300) {
                        resolve(xhr.response);
                    } else {
                        reject({
                            status: this.status,
                            statusText: xhr.statusText
                        });
                    }
                };
                xhr.onerror = function () {
                    reject({
                        status: this.status,
                        statusText: xhr.statusText
                    });
                };
                xhr.send();
            });
        }

var canvas = document.getElementById("canvas").getContext("2d");

var c = document.getElementById("canvas"),
    ratio = window.devicePixelRatio;
c.style.width = c.width + "px";
c.style.height = c.height + "px";
c.width = c.width * ratio;
c.height = c.height * ratio;
canvas.scale(ratio, ratio);

var stroke_input = document.getElementById('stroke-list');
var radicalSet, grand_radical_refs = {};
var char_set_json;

function redrawRadical(){
    var radical_list_json = JSON.parse(stroke_input.value);

    radicalSet = new Radical(char_set_json, radical_list_json, grand_radical_refs);
    // radicalSet.draw();
    console.log(grand_radical_refs);
}

function getCursorPos(input) {
    return {
        start: input.selectionStart,
        end: input.selectionEnd
    };
}

function setCursorPos(input, pos) {
    setTimeout(function() {
        input.selectionStart = pos;
        input.selectionEnd = pos;
    }, 1);
}

function insertPair(input, bracket, pos){
    var cursorPos = getCursorPos(stroke_input),
        input_str = input.value;

    input.value = input_str.slice(0, cursorPos.start) + bracket + input_str.slice(cursorPos.start);
    setCursorPos(input, cursorPos.start+pos);
}

stroke_input.addEventListener('keypress', function(e){
    var complete_dict = {
        "[" : ["[]", 1],
        "'" : ['""', 1],
        '"' : ['""', 1],
        "{" : ['{}', 1],
        "Enter":['\n\n', 1]
    };

    if(e.key==="Enter" && e.ctrlKey){
        redrawRadical();
        return;
    }


    console.log(e.key in complete_dict);
    if(e.key in complete_dict){
        e.preventDefault();
        insertPair(stroke_input, complete_dict[e.key][0], complete_dict[e.key][1]);
    }
});

stroke_input.focus();

loadJSON('data/stroke-spec.json').then(function(data){
    char_set_json = JSON.parse(data);
    redrawRadical();
})


    </script>

</html>

